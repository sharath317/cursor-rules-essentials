---
description: "Visual Regression Guard - Auto-detect UI changes and require visual verification"
category: Testing & Verification
globs: ["**/*.{css,scss,tsx,jsx,styled.ts}"]
alwaysApply: false
severity: warning
---

# ğŸ¨ Visual Regression Guard

Auto-detects UI-affecting changes and requires visual verification before PR merge.

## ğŸ¯ Purpose

UI changes can introduce visual regressions that are hard to catch in code review. This rule ensures visual verification happens automatically.

## ğŸš¨ Trigger Conditions

This rule triggers when:

1. **CSS/SCSS Changes:** Files with `.css` or `.scss` extensions modified
2. **Styled Components:** Files with `.styled.ts` or `.styled.js` modified
3. **Tailwind Classes:** Files containing Tailwind utility classes changed
4. **Component Files:** React components (`.tsx`, `.jsx`) with styling logic modified
5. **Design System Components:** Core design system components modified

## âš ï¸ Action When Triggered

When UI-affecting changes are detected:

```
âš ï¸ VISUAL VERIFICATION REQUIRED
â”œâ”€ UI Changes Detected:
â”‚   â”œâ”€ Button.styled.ts (styled components)
â”‚   â”œâ”€ MainWithBooking.tsx (component with styling)
â”‚   â””â”€ styles.css (CSS changes)
â”‚
â”œâ”€ Risk Assessment:
â”‚   â”œâ”€ Visual Regression Risk: ğŸŸ¡ Medium
â”‚   â”œâ”€ Components Affected: 3
â”‚   â””â”€ Design System Impact: Low (no core components)
â”‚
â”œâ”€ Required Actions:
â”‚   â”œâ”€ Run: /vibe-check to verify visual changes
â”‚   â”œâ”€ Check: Storybook stories for affected components
â”‚   â””â”€ Compare: Against Figma designs (if available)
â”‚
â””â”€ Buddy Integration: Added to Quick Actions [B] Visual Check
```

## ğŸ”— Integration with Buddy

When Buddy detects UI changes in a PR or branch:

1. **Quick Actions:** Adds "Visual Verification Needed" to Buddy's Quick Actions
2. **Priority Boost:** UI changes without verification get +4 priority score
3. **PR Checklist:** Auto-adds visual verification to PR checklist
4. **Auto-Suggest:** Suggests `/vibe-check` in Buddy's recommendations

### Buddy Output Enhancement

```
ğŸ¯ Priority 2: Review PR #22950 [Score: 7.8]
â”œâ”€ Why: UI changes detected (3 files)
â”œâ”€ Visual Risk: ğŸŸ¡ Medium (Button, Card, Layout components)
â”œâ”€ Verification: âš ï¸ Not yet verified
â”œâ”€ Quick Actions:
â”‚   [A] Start Review
â”‚   [B] Run Visual Check (/vibe-check) â† NEW
â”‚   [C] Check Storybook
â””â”€ If delayed: Visual regressions may slip through
```

## ğŸ”— Integration with /vibe-check

The `/vibe-check` command should be enhanced:

```
/vibe-check --auto          # Auto-run when UI changes detected
/vibe-check --pr            # Check all UI changes in PR
/vibe-check --buddy         # Run from Buddy's Quick Action
```

## ğŸ”— Integration with /full-flow

When `/full-flow` completes with UI changes:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  /full-flow RBW-3459                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  1. âœ… Fetch ticket                                         â”‚
â”‚  2. âœ… Implement changes                                    â”‚
â”‚  3. âœ… pnpm compile - passed                                â”‚
â”‚  4. âœ… pnpm lint - passed                                   â”‚
â”‚  5. âœ… pnpm test - passed                                    â”‚
â”‚  6. ğŸ¨ UI Changes Detected:                                 â”‚
â”‚     â”œâ”€ Button.styled.ts                                     â”‚
â”‚     â””â”€ Card.tsx                                             â”‚
â”‚  7. ğŸ¨ /vibe-check - Running... (auto-triggered)           â”‚
â”‚     â””â”€â”€ Checking 2 changed components                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ“‹ Detection Patterns

### CSS/SCSS Files
```typescript
// Triggers on any .css or .scss file change
glob: ["**/*.css", "**/*.scss"]
```

### Styled Components
```typescript
// Triggers on .styled.ts or .styled.js files
glob: ["**/*.styled.ts", "**/*.styled.js"]
```

### Tailwind Classes
```typescript
// Detects Tailwind utility classes in JSX/TSX
pattern: /className=["'].*?(?:bg-|text-|p-|m-|flex|grid|w-|h-)/g
```

### Component Styling Logic
```typescript
// Detects inline styles or style objects
pattern: /style=\{|style:\s*\{/g
```

## ğŸ¯ Goal

**Catch visual regressions before they reach production.**

Visual regressions are:
- Hard to catch in code review
- Expensive to fix after release
- Damage user experience
- Reduce design system consistency

**Automatic visual verification prevents these issues.**

---

## ğŸ”„ Feedback Loop

After visual regressions are caught:
1. Track which components/files cause most regressions
2. Update detection patterns to catch similar issues earlier
3. Improve `/vibe-check` accuracy based on findings
4. Learn which UI changes are highest risk
