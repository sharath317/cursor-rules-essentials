---
description: "Refactoring Gravity - Identifies high-churn files with high coupling (import dependencies)"
category: Analysis & Refactoring
globs: ["**/*.{ts,tsx,js,jsx}"]
alwaysApply: false
severity: warning
---

# ğŸ”´ Refactoring Gravity - Coupling Analysis

Identifies files with **High Churn + High Gravity** (coupling) that are critical refactoring candidates.

## ğŸ¯ Purpose

Churn frequency alone doesn't tell the full story. A file with 50 commits that **100 files import** is much more dangerous than a file with 50 commits that **2 files import**.

**Gravity** measures how many other files break when this file changes.

## ğŸ“Š Gravity Calculation

```
Gravity Score = (Afferent Coupling Ã— 2) + (Efferent Coupling Ã— 1) + (Import Frequency Ã— 0.5)

Where:
- Afferent Coupling = How many files import this file (incoming dependencies)
- Efferent Coupling = How many files this file imports (outgoing dependencies)
- Import Frequency = How often imports change (churn in import statements)
```

### Gravity Levels

| Level | Score Range | Meaning |
|-------|-------------|---------|
| ğŸŸ¢ Low | 0-10 | Safe, low coupling |
| ğŸŸ¡ Medium | 11-30 | Moderate coupling, monitor |
| ğŸ”´ High | 31-60 | High coupling, refactor candidate |
| ğŸ”¥ Critical | 61+ | Critical refactor needed |

## ğŸš¨ Trigger Conditions

This rule triggers when:

1. **High Churn Detected:** File has >50 commits in last 6 months (via `/churn-map`)
2. **High Gravity Detected:** Gravity score >30 (High or Critical)
3. **File Modified:** User is editing a file with High Churn + High Gravity

## âš ï¸ Action When Triggered

When a file with **High Churn + High Gravity** is detected:

```
âš ï¸ REFACTORING GRAVITY WARNING
â”œâ”€ File: MainWithBooking.tsx
â”œâ”€ Churn: ğŸ”´ Critical (145 commits/6mo)
â”œâ”€ Gravity: ğŸ”¥ Critical (78 score)
â”‚   â”œâ”€ Afferent: 42 files import this
â”‚   â”œâ”€ Efferent: 15 files imported
â”‚   â””â”€ Import Frequency: High (imports change often)
â”‚
â”œâ”€ Risk Assessment:
â”‚   â”œâ”€ Blast Radius: ğŸ”´ Very High (42 files affected)
â”‚   â”œâ”€ Refactor Priority: ğŸ”¥ Critical
â”‚   â””â”€ Estimated Impact: High (many files break on change)
â”‚
â”œâ”€ Recommendations:
â”‚   â”œâ”€ Run: /churn-map --gravity for full analysis
â”‚   â”œâ”€ Run: /refactor-impact MainWithBooking.tsx
â”‚   â”œâ”€ Consider: /migration-plan for structured refactor
â”‚   â””â”€ Suggest: Extract into smaller, decoupled modules
â”‚
â””â”€ Buddy Integration: This will appear in next /buddy snapshot
```

## ğŸ”— Integration with Buddy

When Buddy detects you're modifying a high-gravity file:

1. **Drift Mode Enhanced:** Shows Gravity score alongside Churn
2. **Priority Boost:** High Churn + High Gravity tasks get +7 priority score
3. **Refactor Suggestion:** Auto-suggests refactor in Buddy's Quick Actions
4. **Migration Guide:** Pre-loads migration guides if available

## ğŸ”— Integration with /churn-map

The `/churn-map` command should include Gravity analysis:

```
/churn-map {PATH} --gravity
/churn-map apps/rent-checkout --gravity --last=6mo
```

**Output Enhancement:**
```
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  ğŸ”´ HIGH GRAVITY + HIGH CHURN (Critical Refactor Candidates)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

| File | Churn | Gravity | Afferent | Efferent | Priority |
|------|-------|---------|----------|----------|----------|
| MainWithBooking.tsx | ğŸ”¥ 145 | ğŸ”¥ 78 | 42 | 15 | ğŸ”¥ Critical |
| BookingDetails.tsx | ğŸ”¥ 128 | ğŸ”´ 65 | 38 | 12 | ğŸ”¥ Critical |
| PackagesV2.tsx | âš ï¸ 89 | ğŸŸ¡ 28 | 12 | 8 | ğŸŸ¡ Monitor |

Recommendation: Files with ğŸ”¥ Critical Gravity + High Churn should be
refactored immediately to prevent cascading technical debt.
```

## ğŸ“‹ Implementation Notes

### How to Calculate Gravity

1. **Afferent Coupling (Incoming):**
   ```bash
   # Count files that import this file
   grep -r "from.*MainWithBooking" --include="*.{ts,tsx,js,jsx}" | wc -l
   ```

2. **Efferent Coupling (Outgoing):**
   ```bash
   # Count imports in this file
   grep -E "^import.*from" MainWithBooking.tsx | wc -l
   ```

3. **Import Frequency:**
   ```bash
   # Count commits that changed import statements
   git log --oneline --all -- "**/MainWithBooking.tsx" | \
     xargs -I {} git show {} --stat | grep -E "import|from" | wc -l
   ```

### AST-Based Analysis (More Accurate)

For more accurate analysis, use AST parsing:
- Parse TypeScript/JavaScript files
- Extract import/export statements
- Build dependency graph
- Calculate coupling metrics

## ğŸ¯ Goal

**Prevent high-coupling files from becoming technical debt time bombs.**

Files with High Churn + High Gravity are:
- Hard to change (many files break)
- Hard to test (many dependencies)
- Hard to refactor (high risk)
- High maintenance cost

**Refactoring these files early prevents compound technical debt.**

---

## ğŸ”„ Feedback Loop

After refactoring a high-gravity file:
1. Track actual maintenance cost reduction
2. Compare to predicted ROI
3. Update Gravity calculation if needed
4. Learn which refactoring patterns work best
